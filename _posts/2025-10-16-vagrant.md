---
layout: post
title: Vagrant
---
Vagrant is a tool for managing the lifecycle of a VM- create, destroy and other things in between. It's very useful to quickly spin up temporary VMs on a local machine. It was written by Mitchell HashiCorp, the founder of HashiCorp, in 2010, two years before HashiCorp. It works with most virtualization softwares such as VirtualBox, VMware, Hyper-V etc. 

# Table of Contents
- [Why Vagrant?](#why-vagrant)
- [Setup](#setup)
- [Spin up VM](#spin-up-vm)
- [Most used commands](#most-used-commands)
- [Access guest service from outside](#access-guest-service-from-outside)
- [Dual box setup](#dual-box-setup)
- [Provisioner](#provisioner)
- [ARM support](#arm-support)
- [My Vagrantfiles](#my-vagrantfiles)
- [vagrant global-status](#vagrant-global-status)

## Why Vagrant
Instead of spending time manually creating a VM and installing the OS which will take a few dozen minutes, how about running a few simple commands to get our VM ready? Using an [image](https://www.osboxes.org/virtualbox-images/) instead of installing it from ISO will save you sometime but Vagrant will be still be much faster. 

Watch how simple it is to get an Ubuntu VM.
```
vagrant init bento/ubuntu-22.04 --box-version 202508.03.0
vagrant up
```

Just two commands and the VM is ready. 
```
vagrant ssh
vagrant@vagrant:~$ lsb_release -a
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 22.04.5 LTS
Release:	22.04
Codename:	jammy
vagrant@vagrant:~$
```
## Setup
Install Vagrant and the virtualization provider of your choice. I use VirtualBox. 
```
VBoxManage --version
7.1.10r169112

vagrant -v
Vagrant 2.4.7
```
Check the Vagrant documentation for the compatibility between Vagrant and Vbox versions.

## Spin up VM
Lets spin up a VM the Vagrant way and look at the steps in detail.

1. Find the template, hereafter box, of your choice from [Vagrant Public Registry](https://portal.cloud.hashicorp.com/vagrant/discover?query=). We will use [bento/ubuntu-22.04](https://portal.cloud.hashicorp.com/vagrant/discover/bento/ubuntu-22.04). 

2. Create new directory and go there
    ```
    mkdir ubuntu
    cd ubuntu/
    ```
   Each VM should be in their own directory, because you cannot have more than one Vagrantfile in a directory.

3. Copy the init command on the right side of the bento page and run it.
    ```
    vagrant init bento/ubuntu-22.04 --box-version 202508.03.0
    ```
    This downloads the Vagrantfile, which is the Vagrant configuration for the project. A project can have one or multiple VMs. We will come back to this.
4. Bring up the VM.
    ```
    vagrant up
    ```
    As this is the first time, it will download the image from the registry and starts the VM. If there are no errors, your VM is ready.
5. Get into the VM
    ```
    vagrant ssh
    ```
    Vagrant boxes ship with the public key of vagrant and the vagrant software has the private key. This enables password-less SSH to the VM. 

6. What is in the Vagrantfile?
    ```
    grep -v  # Vagrantfile | grep -v ^$
    Vagrant.configure("2") do |config|
        config.vm.box = "bento/ubuntu-22.04"
        config.vm.box_version = "202508.03.0"
    end
    ```
    You will that it is full of comments explaining what each part does. If you remove the comments, there are 4 lines only.

    The box_version is optional. It used to note which version of the box is used as they are regularly updated. 

    If we run the vagrant init command without `--box-version 202508.03.0`, there will be just three uncommented lines, out of which the name of box (config.vm.box) is the only actual parameter. 
    ```
    grep -v  # Vagrantfile | grep -v ^$
    Vagrant.configure("2") do |config|
        config.vm.box = "bento/ubuntu-22.04"
    end
    ```
    The rest are defaults.

## Most used commands
You need to be inside the directory of a box to run these commands.
1. Download a Vagrant box
    ```
    vagrant init box_name
    ```
1. Start your box
    ```
    vagrant up
    ```
1. Find the status
    ```
    vagrant status
    ```
1. SSH to your box
    ```
    vagrant ssh
    ```
1. Shutdown your box
    ```
    vagrant halt
    ```
1. Delete your box
    ```
    vagrant destroy
    ```

## Access guest service from outside
I can't speak for other providers. With VBox, Vagrant creates a NAT network. It can go out to the network but we cannot go in directly. There are two ways to reach services running in the box.
1. Port Forward: There is an httpd service in the box listening on port 80. To access it from the host on port 8080, add the `config.vm.network "forwarded_port", guest: 80, host: 8080` to the Vagrantfile and restart it.

   ```
   cat Vagrantfile
    Vagrant.configure("2") do |config|
        config.vm.box = "bento/ubuntu-22.04"
        config.vm.network "forwarded_port", guest: 80, host: 8080
    end
    ```
2. Host-only Network
    - In VBox, create a Host-only network. In my example, I name it vagrantnet-vbox1.
    - Add to Vagrantfile `config.vm.network "private_network", type: "dhcp", name: "vagrantnet-vbox1"`.
    It should look like:
        ```
        cat Vagrantfile
        Vagrant.configure("2") do |config|
            config.vm.box = "bento/ubuntu-22.04"
            config.vm.network "private_network", type: "dhcp", name: "vagrantnet-vbox1"
        end
        ```
    - Restart
    - SSH into the box and find the IP attached to the Host-only network
    - Use the IP to access the service from the host
    - You can identify the IP based on the range. To find the Host-only network range, run `VBoxManage list hostonlynets`. Or check it from the Network section in the VBox GUI.

## Dual box setup
If you need two boxes to be managed in a single Vagrantfile:
```
cat Vagrantfile
Vagrant.configure("2") do |config|
  # Define first VM
  config.vm.define "ubuntu1" do |ubuntu1|
    ubuntu1.vm.box = "bento/ubuntu-22.04"
    ubuntu1.vm.hostname = "ubuntu1"
  end

  # Define second VM
  config.vm.define "ubuntu2" do |ubuntu2|
    ubuntu2.vm.box = "bento/ubuntu-22.04"
    ubuntu2.vm.hostname = "ubuntu2"
  end
end
```

They are identified by the hostname.
```
vagrant status
Current machine states:

ubuntu1                   running (virtualbox)
ubuntu2                   running (virtualbox)
```
For more information about a specific
VM, run `vagrant status NAME`.

Similarly to SSH into ubuntu1:
```
vagrant ssh ubuntu1
```


## Provisioner
You can install packages and configure the OS using the provisioner at the time of initial setup. To install Apache, enable and start the service:
```
cat Vagrantfile
Vagrant.configure("2") do |config|
  config.vm.box = "bento/ubuntu-22.04"
  config.vm.network "forwarded_port", guest: 80, host: 8080
  config.vm.provision "shell", inline: <<-SHELL
    sudo apt update -y
    sudo apt install apache2 -y
    sudo systemctl enable apache2
    sudo systemctl start apache2
  SHELL
end
```

Note that I am forwarding the port too. Once the box comes up, the web service can be accessed from the host at `http://localhost:8080`.

The provision block is executed the first time you run `vagrant up` and any time you run `vagrant provision`.

Alternately, you can write the list of commands in a shell script and have Vagrant execute it.

```
cat Vagrantfile
Vagrant.configure("2") do |config|
  config.vm.box = "bento/ubuntu-22.04"
  config.vm.provision "shell", path: "setup.sh"
  config.vm.network "private_network", type: "dhcp", name: "vagrantnet-vbox1"
end
```
```
head setup.sh
sudo apt update -y
sudo apt install git -y
sudo apt install openjdk-17-jdk -y
java -version
sudo snap install ngrok

sudo wget -O /usr/share/keyrings/jenkins-keyring.asc https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
echo "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/" | sudo tee /etc/apt/sources.list.d/jenkins.list > /dev/null

sudo apt update -y
```

## ARM support
You need to verify the box you pick supports the combination of your provider and CPU architecture. For example.

1. In the registry, you search for debian 12
1. At the top of list is  generic/debian12. You see virtualbox under Providers and arm under Architecture. 
1. Open the [generic/debian12](https://portal.cloud.hashicorp.com/vagrant/discover/generic/debian12) page, and scroll down to virtualbox, you see amd64 and i386 only. 
 
## My Vagrantfiles
My [Vagrantfiles](https://github.com/rualthan/vagrantfiles) are on GitHub.

## vagrant global-status
To check the status of all Vagrant managed VMs on the host.
```
vagrant global-status
```

If you see VMs that do not exist anymore, clear the cache.
```
vagrant global-status --prune
```
